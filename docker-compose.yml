
services:
  router:
    build: ./router
    container_name: agent-router
    environment:
      - WORKSPACE_ROOT=${WORKSPACE_ROOT}
    ports:
      - "8080:8080"
    volumes:
      - workspaces:${WORKSPACE_ROOT}
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
    depends_on:
      - runner
      - browser
    restart: unless-stopped
    command: ["bash", "-lc", "mkdir -p ${WORKSPACE_ROOT}/default ${WORKSPACE_ROOT}/launchbase-platform ${WORKSPACE_ROOT}/launchbase-showrooms && exec uvicorn app.main:app --host 0.0.0.0 --port 8080"]

  runner:
    build: ./runner
    container_name: agent-runner
    volumes:
      - workspaces:${WORKSPACE_ROOT}
    working_dir: ${WORKSPACE_ROOT}
    restart: unless-stopped

  browser:
    build: ./browser
    container_name: agent-browser
    environment:
      - WORKSPACE_ROOT=${WORKSPACE_ROOT}
      - BROWSER_ALLOWED_DOMAINS=${BROWSER_ALLOWED_DOMAINS}
    volumes:
      - workspaces:${WORKSPACE_ROOT}
    ports:
      - "9222:9222"
    depends_on:
      - runner
    restart: unless-stopped
    command: ["bash", "-lc", "mkdir -p /workspaces/default && exec sleep infinity"]

volumes:
  workspaces:
