
services:
  router:
    build: ./router
    container_name: agent-router
    environment:
      - WORKSPACE_ROOT=${WORKSPACE_ROOT}
      - ROUTER_AUTH_TOKEN=${ROUTER_AUTH_TOKEN}
      - PLATFORM_BASE_URL=${PLATFORM_BASE_URL}
      - PLATFORM_AUTH_TOKEN=${PLATFORM_AUTH_TOKEN}
      - CONTRACT_HANDSHAKE_TIMEOUT=${CONTRACT_HANDSHAKE_TIMEOUT:-10}
      - CONTRACT_HANDSHAKE_RETRIES=${CONTRACT_HANDSHAKE_RETRIES:-3}
      - CONTRACT_HANDSHAKE_FAIL_EXIT=${CONTRACT_HANDSHAKE_FAIL_EXIT:-false}
      - CONTRACT_HANDSHAKE_CACHE_TTL=${CONTRACT_HANDSHAKE_CACHE_TTL:-60}
      - AUDIT_LOG_DIR=/logs
    ports:
      - "8080:8080"
    volumes:
      - workspaces:${WORKSPACE_ROOT}
      - agent-logs:/logs
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
    depends_on:
      - runner
      - browser
    restart: unless-stopped
    command: ["bash", "-lc", "mkdir -p ${WORKSPACE_ROOT}/default ${WORKSPACE_ROOT}/launchbase-platform ${WORKSPACE_ROOT}/launchbase-showrooms && exec uvicorn app.main:app --host 0.0.0.0 --port 8080"]

  runner:
    build: ./runner
    container_name: agent-runner
    volumes:
      - workspaces:${WORKSPACE_ROOT}
    working_dir: ${WORKSPACE_ROOT}
    restart: unless-stopped

  browser:
    build: ./browser
    container_name: agent-browser
    environment:
      - WORKSPACE_ROOT=${WORKSPACE_ROOT}
      - BROWSER_ALLOWED_DOMAINS=${BROWSER_ALLOWED_DOMAINS}
    volumes:
      - workspaces:${WORKSPACE_ROOT}
    ports:
      - "9222:9222"
    depends_on:
      - runner
    restart: unless-stopped
    command: ["bash", "-lc", "mkdir -p /workspaces/default && exec sleep infinity"]

volumes:
  workspaces:
  agent-logs:
